// content.js - ÐŸÐ¾Ð»Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð° Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð° Ð²Ð¸Ð´ÐµÐ¾
console.log('ðŸŽ¯ Translateme content script loaded');

let isTranslating = false;
let audioContext = null;
let sourceNode = null;
let videoElement = null;
let translationInterval = null;
let subtitlesContainer = null;

chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    
    switch (request.type) {
        case 'GET_TRANSLATION_STATUS':
            sendResponse({ isTranslating, videoElement: !!videoElement });
            break;
            
        case 'START_TRANSLATION':
            const success = startTranslation(request.settings);
            sendResponse({ success });
            break;
            
        case 'STOP_TRANSLATION':
            const stopped = stopTranslation();
            sendResponse({ success: stopped });
            break;
            
        case 'GET_VIDEO_INFO':
            const videos = getPageVideos();
            sendResponse({ videos: videos.length });
            break;
    }
    return true;
});

function startTranslation(settings = {}) {
    if (isTranslating) {
        console.log('âš ï¸ Already translating');
        return false;
    }
    
    const videos = getPageVideos();
    if (videos.length === 0) {
        showNotification('No video found on this page', 'error');
        return false;
    }
    
    videoElement = videos[0];
    
    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð°ÑƒÐ´Ð¸Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        sourceNode = audioContext.createMediaElementSource(videoElement);
        
        // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ†ÐµÐ¿Ð¾Ñ‡ÐºÑƒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð°ÑƒÐ´Ð¸Ð¾
        const analyzer = audioContext.createAnalyser();
        const destination = audioContext.createMediaStreamDestination();
        
        sourceNode.connect(analyzer);
        analyzer.connect(audioContext.destination);
        
        // Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð·Ð°Ð³Ð»ÑƒÑˆÐ¸Ñ‚ÑŒ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»
        if (settings.muteOriginal) {
            videoElement.muted = true;
            videoElement.volume = 0;
        }
        
        isTranslating = true;
        
        // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¾ÐºÐ½Ð¾ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€Ð¾Ð²
        if (settings.showSubtitles !== false) {
            createSubtitlesContainer(settings.targetLanguage || 'ru');
        }
        
        // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°
        startTranslationLoop(settings);
        
        showNotification('Translation started!', 'success');
        console.log('âœ… Translation started successfully');
        return true;
        
    } catch (error) {
        showNotification('Audio capture failed', 'error');
        return false;
    }
}

function stopTranslation() {
    if (!isTranslating) return true;
    
    isTranslating = false;
    
    if (translationInterval) {
        clearInterval(translationInterval);
        translationInterval = null;
    }

    if (videoElement) {
        videoElement.muted = false;
        videoElement.volume = 1.0;
    }
    
    if (audioContext) {
        audioContext.close();
        audioContext = null;
        sourceNode = null;
    }

    if (subtitlesContainer) {
        subtitlesContainer.remove();
        subtitlesContainer = null;
    }
    
    videoElement = null;
    showNotification('Translation stopped', 'info');
    return true;
}

function startTranslationLoop(settings) {
    let lastProcessTime = 0;
    const processInterval = 10000;
    
    translationInterval = setInterval(async () => {
        if (!isTranslating || !videoElement) return;
        
        const now = Date.now();
        if (now - lastProcessTime < processInterval) return;
        
        try {
            const audioChunk = await captureAudioChunk();
            if (!audioChunk) return;

            const result = await chrome.runtime.sendMessage({
                type: 'PROCESS_AUDIO_CHUNK',
                audioData: audioChunk,
                settings: settings
            });
            
            if (result && result.success) {

                if (subtitlesContainer && result.text) {
                    updateSubtitles(result.text);
                }
                
                if (result.audioUrl) {
                    playTranslatedAudio(result.audioUrl, settings.muteOriginal);
                }
                
                chrome.runtime.sendMessage({
                    type: 'LOG_USAGE',
                    seconds: 10
                });
            }
            
            lastProcessTime = now;
            
        } catch (error) {
            console.error('âŒ Translation loop error:', error);
        }
    }, 1000);
}


async function captureAudioChunk() {
    if (!audioContext || !sourceNode) return null;
    
    try {
        const stream = audioContext.createMediaStreamDestination().stream;
        const recorder = new MediaRecorder(stream);
        
        const chunks = [];
        recorder.ondataavailable = (e) => chunks.push(e.data);
        
        const recordingPromise = new Promise(resolve => {
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                resolve(blob);
            };
        });
        
        recorder.start();
        await new Promise(resolve => setTimeout(resolve, 5000));
        recorder.stop();
        
        return await recordingPromise;
        
    } catch (error) {
        return null;
    }
}


function createSubtitlesContainer(language) {
    if (subtitlesContainer) {
        subtitlesContainer.remove();
    }
    
    subtitlesContainer = document.createElement('div');
    subtitlesContainer.id = 'translateme-subtitles';
    subtitlesContainer.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 500;
        max-width: 70%;
        text-align: center;
        z-index: 999999;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: opacity 0.3s;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    `;
    
    const langBadge = document.createElement('div');
    langBadge.textContent = `â†’ ${language.toUpperCase()}`;
    langBadge.style.cssText = `
        font-size: 12px;
        opacity: 0.7;
        margin-bottom: 5px;
    `;
    
    subtitlesContainer.appendChild(langBadge);
    
    const textElement = document.createElement('div');
    textElement.id = 'translateme-subtitle-text';
    textElement.textContent = 'Waiting for translation...';
    textElement.style.cssText = 'min-height: 24px;';
    
    subtitlesContainer.appendChild(textElement);
    document.body.appendChild(subtitlesContainer);
}

function updateSubtitles(text) {
    if (!subtitlesContainer) return;
    
    const textElement = document.getElementById('translateme-subtitle-text');
    if (textElement) {
        textElement.textContent = text;
        subtitlesContainer.style.opacity = '0';
        setTimeout(() => {
            subtitlesContainer.style.opacity = '1';
        }, 10);
        
        setTimeout(() => {
            if (subtitlesContainer) {
                subtitlesContainer.style.opacity = '0';
            }
        }, 5000);
    }
}

function playTranslatedAudio(audioUrl, muteOriginal = false) {
    const audio = new Audio(audioUrl);
    audio.volume = muteOriginal ? 1.0 : 0.7;
    
    audio.play().catch(error => {
        console.error('âŒ Audio play error:', error);
    });
}

function getPageVideos() {
    return Array.from(document.querySelectorAll('video')).filter(video => {
        return video.offsetWidth > 100 && 
               video.offsetHeight > 100 && 
               !video.paused;
    });
}

function showNotification(message, type = 'info') {
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6'
    };
    
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 999999;
        font-family: sans-serif;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: fadeIn 0.3s;
    `;
    
    notification.textContent = `ðŸŽ¯ Translateme: ${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

document.addEventListener('DOMContentLoaded', () => {
    const videos = getPageVideos();
    if (videos.length > 0) {
        chrome.storage.local.get(['autoStart'], (result) => {
            if (result.autoStart) {
                startTranslation();
            }
        });
    }
    
    if (!document.getElementById('translateme-styles')) {
        const style = document.createElement('style');
        style.id = 'translateme-styles';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
});

window.addEventListener('beforeunload', () => {
    if (isTranslating) {
        stopTranslation();
    }
});
