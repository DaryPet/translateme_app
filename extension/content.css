// content.js - ÐŸÐ¾Ð»Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð° Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð° Ð²Ð¸Ð´ÐµÐ¾
console.log('ðŸŽ¯ Translateme content script loaded');

let isTranslating = false;
let audioContext = null;
let sourceNode = null;
let videoElement = null;
let translationInterval = null;
let subtitlesContainer = null;

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    console.log('ðŸ“© Message:', request.type);
    
    switch (request.type) {
        case 'GET_TRANSLATION_STATUS':
            sendResponse({ isTranslating, videoElement: !!videoElement });
            break;
            
        case 'START_TRANSLATION':
            const success = startTranslation(request.settings);
            sendResponse({ success });
            break;
            
        case 'STOP_TRANSLATION':
            const stopped = stopTranslation();
            sendResponse({ success: stopped });
            break;
            
        case 'GET_VIDEO_INFO':
            const videos = getPageVideos();
            sendResponse({ videos: videos.length });
            break;
    }
    return true;
});

// ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ ÑÑ‚Ð°Ñ€Ñ‚Ð° Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°
function startTranslation(settings = {}) {
    if (isTranslating) {
        console.log('âš ï¸ Already translating');
        return false;
    }
    
    const videos = getPageVideos();
    if (videos.length === 0) {
        console.error('âŒ No video elements found');
        showNotification('No video found on this page', 'error');
        return false;
    }
    
    videoElement = videos[0];
    console.log('ðŸŽ¬ Video found:', videoElement.src);
    
    // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð°ÑƒÐ´Ð¸Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        sourceNode = audioContext.createMediaElementSource(videoElement);
        
        // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ñ†ÐµÐ¿Ð¾Ñ‡ÐºÑƒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð°ÑƒÐ´Ð¸Ð¾
        const analyzer = audioContext.createAnalyser();
        const destination = audioContext.createMediaStreamDestination();
        
        sourceNode.connect(analyzer);
        analyzer.connect(audioContext.destination);
        
        // Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð·Ð°Ð³Ð»ÑƒÑˆÐ¸Ñ‚ÑŒ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»
        if (settings.muteOriginal) {
            videoElement.muted = true;
            videoElement.volume = 0;
        }
        
        isTranslating = true;
        
        // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¾ÐºÐ½Ð¾ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€Ð¾Ð²
        if (settings.showSubtitles !== false) {
            createSubtitlesContainer(settings.targetLanguage || 'ru');
        }
        
        // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°
        startTranslationLoop(settings);
        
        showNotification('Translation started!', 'success');
        console.log('âœ… Translation started successfully');
        return true;
        
    } catch (error) {
        console.error('âŒ Audio context error:', error);
        showNotification('Audio capture failed', 'error');
        return false;
    }
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°
function stopTranslation() {
    if (!isTranslating) return true;
    
    isTranslating = false;
    
    // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»Ñ‹
    if (translationInterval) {
        clearInterval(translationInterval);
        translationInterval = null;
    }
    
    // Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð°ÑƒÐ´Ð¸Ð¾
    if (videoElement) {
        videoElement.muted = false;
        videoElement.volume = 1.0;
    }
    
    // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð°ÑƒÐ´Ð¸Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
    if (audioContext) {
        audioContext.close();
        audioContext = null;
        sourceNode = null;
    }
    
    // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€Ñ‹
    if (subtitlesContainer) {
        subtitlesContainer.remove();
        subtitlesContainer = null;
    }
    
    videoElement = null;
    showNotification('Translation stopped', 'info');
    console.log('ðŸ›‘ Translation stopped');
    return true;
}

// ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ†Ð¸ÐºÐ» Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°
function startTranslationLoop(settings) {
    let lastProcessTime = 0;
    const processInterval = 10000; // ÐšÐ°Ð¶Ð´Ñ‹Ðµ 10 ÑÐµÐºÑƒÐ½Ð´
    
    translationInterval = setInterval(async () => {
        if (!isTranslating || !videoElement) return;
        
        const now = Date.now();
        if (now - lastProcessTime < processInterval) return;
        
        try {
            console.log('ðŸ”„ Processing audio chunk...');
            
            // 1. Ð—Ð°Ñ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð°ÑƒÐ´Ð¸Ð¾ ÑÐµÐ³Ð¼ÐµÐ½Ñ‚
            const audioChunk = await captureAudioChunk();
            if (!audioChunk) return;
            
            // 2. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² background Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
            const result = await chrome.runtime.sendMessage({
                type: 'PROCESS_AUDIO_CHUNK',
                audioData: audioChunk,
                settings: settings
            });
            
            // 3. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ²ÐµÐ´Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð¸ Ð°ÑƒÐ´Ð¸Ð¾
            if (result && result.success) {
                console.log('ðŸ“ Translation:', result.text);
                
                // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€Ñ‹
                if (subtitlesContainer && result.text) {
                    updateSubtitles(result.text);
                }
                
                // Ð’Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ð¼ Ð¿ÐµÑ€ÐµÐ²ÐµÐ´Ñ‘Ð½Ð½ÑƒÑŽ Ñ€ÐµÑ‡ÑŒ
                if (result.audioUrl) {
                    playTranslatedAudio(result.audioUrl, settings.muteOriginal);
                }
                
                // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
                chrome.runtime.sendMessage({
                    type: 'LOG_USAGE',
                    seconds: 10
                });
            }
            
            lastProcessTime = now;
            
        } catch (error) {
            console.error('âŒ Translation loop error:', error);
        }
    }, 1000); // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ ÑÐµÐºÑƒÐ½Ð´Ñƒ
}

// Ð—Ð°Ñ…Ð²Ð°Ñ‚ Ð°ÑƒÐ´Ð¸Ð¾ ÑÐµÐ³Ð¼ÐµÐ½Ñ‚Ð°
async function captureAudioChunk() {
    if (!audioContext || !sourceNode) return null;
    
    try {
        // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ MediaRecorder Ð´Ð»Ñ Ð·Ð°Ñ…Ð²Ð°Ñ‚Ð°
        const stream = audioContext.createMediaStreamDestination().stream;
        const recorder = new MediaRecorder(stream);
        
        const chunks = [];
        recorder.ondataavailable = (e) => chunks.push(e.data);
        
        const recordingPromise = new Promise(resolve => {
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                resolve(blob);
            };
        });
        
        recorder.start();
        await new Promise(resolve => setTimeout(resolve, 5000)); // 5 ÑÐµÐºÑƒÐ½Ð´ Ð·Ð°Ð¿Ð¸ÑÐ¸
        recorder.stop();
        
        return await recordingPromise;
        
    } catch (error) {
        console.error('âŒ Audio capture error:', error);
        return null;
    }
}

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° Ð´Ð»Ñ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€Ð¾Ð²
function createSubtitlesContainer(language) {
    if (subtitlesContainer) {
        subtitlesContainer.remove();
    }
    
    subtitlesContainer = document.createElement('div');
    subtitlesContainer.id = 'translateme-subtitles';
    subtitlesContainer.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 500;
        max-width: 70%;
        text-align: center;
        z-index: 999999;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: opacity 0.3s;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    `;
    
    const langBadge = document.createElement('div');
    langBadge.textContent = `â†’ ${language.toUpperCase()}`;
    langBadge.style.cssText = `
        font-size: 12px;
        opacity: 0.7;
        margin-bottom: 5px;
    `;
    
    subtitlesContainer.appendChild(langBadge);
    
    const textElement = document.createElement('div');
    textElement.id = 'translateme-subtitle-text';
    textElement.textContent = 'Waiting for translation...';
    textElement.style.cssText = 'min-height: 24px;';
    
    subtitlesContainer.appendChild(textElement);
    document.body.appendChild(subtitlesContainer);
}

// ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÐ±Ñ‚Ð¸Ñ‚Ñ€Ð¾Ð²
function updateSubtitles(text) {
    if (!subtitlesContainer) return;
    
    const textElement = document.getElementById('translateme-subtitle-text');
    if (textElement) {
        textElement.textContent = text;
        
        // ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ
        subtitlesContainer.style.opacity = '0';
        setTimeout(() => {
            subtitlesContainer.style.opacity = '1';
        }, 10);
        
        // ÐÐ²Ñ‚Ð¾ÑÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· 5 ÑÐµÐºÑƒÐ½Ð´
        setTimeout(() => {
            if (subtitlesContainer) {
                subtitlesContainer.style.opacity = '0';
            }
        }, 5000);
    }
}

// Ð’Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ²ÐµÐ´Ñ‘Ð½Ð½Ð¾Ð³Ð¾ Ð°ÑƒÐ´Ð¸Ð¾
function playTranslatedAudio(audioUrl, muteOriginal = false) {
    const audio = new Audio(audioUrl);
    audio.volume = muteOriginal ? 1.0 : 0.7; // Ð“Ñ€Ð¾Ð¼Ñ‡Ðµ ÐµÑÐ»Ð¸ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð» Ð·Ð°Ð³Ð»ÑƒÑˆÑ‘Ð½
    
    audio.play().catch(error => {
        console.error('âŒ Audio play error:', error);
    });
}

// ÐŸÐ¾Ð¸ÑÐº Ð²Ð¸Ð´ÐµÐ¾ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ
function getPageVideos() {
    return Array.from(document.querySelectorAll('video')).filter(video => {
        // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð¸Ð»Ð¸ Ð¾Ñ‡ÐµÐ½ÑŒ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ðµ Ð²Ð¸Ð´ÐµÐ¾
        return video.offsetWidth > 100 && 
               video.offsetHeight > 100 && 
               !video.paused;
    });
}

// Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
function showNotification(message, type = 'info') {
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6'
    };
    
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 999999;
        font-family: sans-serif;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: fadeIn 0.3s;
    `;
    
    notification.textContent = `ðŸŽ¯ Translateme: ${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð²Ð¸Ð´ÐµÐ¾
document.addEventListener('DOMContentLoaded', () => {
    const videos = getPageVideos();
    if (videos.length > 0) {
        console.log(`âœ… Found ${videos.length} video(s) on page`);
        
        // ÐÐ²Ñ‚Ð¾ÑÑ‚Ð°Ñ€Ñ‚ ÐµÑÐ»Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ…
        chrome.storage.local.get(['autoStart'], (result) => {
            if (result.autoStart) {
                console.log('âš¡ Auto-starting translation');
                startTranslation();
            }
        });
    }
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð¸Ð»Ð¸ Ð´Ð»Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ð¹
    if (!document.getElementById('translateme-styles')) {
        const style = document.createElement('style');
        style.id = 'translateme-styles';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
});

// ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
window.addEventListener('beforeunload', () => {
    if (isTranslating) {
        stopTranslation();
    }
});

console.log('ðŸš€ Translateme content script ready');